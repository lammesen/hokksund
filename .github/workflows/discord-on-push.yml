name: Notify Discord on Push

on:
  push:
    branches:
      - main
      - master
      # add more if you want:
      # - develop

jobs:
  discord_notification:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Send Discord embed
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY}"
          BRANCH_NAME="${GITHUB_REF_NAME}"
          ACTOR="${{ github.actor }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          SHORT_SHA="${GITHUB_SHA::7}"

          COMMIT_URL="https://github.com/${REPO_NAME}/commit/${GITHUB_SHA}"

          # Static GitHub logo + name
          BOT_USERNAME="GitHub"
          BOT_AVATAR_URL="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

          TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          PAYLOAD=$(jq -n \
            --arg username "$BOT_USERNAME" \
            --arg avatar_url "$BOT_AVATAR_URL" \
            --arg title "New push to $REPO_NAME" \
            --arg description "$COMMIT_MESSAGE" \
            --arg url "$COMMIT_URL" \
            --arg branch "$BRANCH_NAME" \
            --arg author "$COMMIT_AUTHOR" \
            --arg actor "$ACTOR" \
            --arg sha "$SHORT_SHA" \
            --arg repo "$REPO_NAME" \
            --arg timestamp "$TIMESTAMP" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              embeds: [
                {
                  title: $title,
                  url: $url,
                  description: $description,
                  color: 5814783,
                  timestamp: $timestamp,
                  author: {
                    name: $actor,
                    url: ("https://github.com/" + $actor)
                  },
                  fields: [
                    { name: "Repository", value: $repo, inline: true },
                    { name: "Branch",    value: $branch, inline: true },
                    { name: "Commit",    value: ("`" + $sha + "`"), inline: true },
                    { name: "Committer", value: $author, inline: true }
                  ],
                  footer: {
                    text: "GitHub Actions Â· push"
                  }
                }
              ]
            }'
          )

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
